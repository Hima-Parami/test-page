<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Handwriting Data Collection - ADHD Research</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      max-width: 1200px;
      width: 100%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
      text-align: center;
      padding: 25px;
    }

    .header h1 { font-size: 2em; margin-bottom: 10px; }

    .main-content { padding: 30px; }

    .activity-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .prompt-display {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 15px;
      color: white;
      background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
    }

    .prompt-content { font-size: 3em; font-weight: bold; }
    .prompt-instruction { font-size: 1.2em; opacity: 0.9; }

    .canvas-container {
      position: relative;
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    #drawingCanvas {
      border: 3px solid #ddd;
      border-radius: 15px;
      background: #fafafa;
      cursor: crosshair;
      touch-action: none;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 800px;
      height: 400px;
    }

    #templateCanvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      border-radius: 15px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      color: white;
    }

    .btn-primary { background: linear-gradient(45deg, #4CAF50, #45a049); }
    .btn-secondary { background: linear-gradient(45deg, #FF6B6B, #FF5252); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 7px 20px rgba(0,0,0,0.3); }

    .stats {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .stat-item {
      text-align: center;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 10px;
      min-width: 120px;
    }

    .stat-value {
      font-size: 1.8em;
      font-weight: bold;
      color: #4CAF50;
    }

    .stat-label { color: #666; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Handwriting Data Collection</h1>
      <p>ADHD Detection Research Tool</p>
    </div>

    <div class="main-content">
      <div class="activity-section">
        <div class="prompt-display">
          <div class="prompt-content" id="currentPrompt">‡∂Ö‡∂∏‡∑ä‡∂∏‡∑è</div>
          <div class="prompt-instruction" id="currentInstruction">
            Write this Sinhala word: Mother
          </div>
        </div>

        <div class="canvas-container">
          <canvas id="drawingCanvas" width="800" height="400"></canvas>
          <canvas id="templateCanvas" width="800" height="400"></canvas>
        </div>

        <div class="stats">
          <div class="stat-item">
            <div class="stat-value" id="pointCount">0</div>
            <div class="stat-label">Points</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="strokeCount">0</div>
            <div class="stat-label">Strokes</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="writingTime">0s</div>
            <div class="stat-label">Time</div>
          </div>
        </div>

        <div class="controls">
          <button class="btn btn-secondary" id="clearBtn">üóëÔ∏è Clear</button>
          <button class="btn btn-primary" id="saveBtn">üíæ Save Data</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let canvas, ctx;
    let isDrawing = false;
    let drawingData = [];
    let currentStroke = [];
    let strokeCount = 0;
    let startTime = null;

    function initializeCanvas() {
      canvas = document.getElementById("drawingCanvas");
      ctx = canvas.getContext("2d");

      ctx.lineWidth = 3;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#333";

      // Use pointer events for real pressure capture
      canvas.addEventListener("pointerdown", handleStart);
      canvas.addEventListener("pointermove", handleMove);
      canvas.addEventListener("pointerup", handleEnd);
      canvas.addEventListener("pointerleave", handleEnd);
      canvas.addEventListener("pointercancel", handleEnd);
    }

    function getEventPos(e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;

      return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY,
        timestamp: Date.now(),
        pressure: e.pressure !== undefined ? e.pressure : 0.5,
        tiltX: e.tiltX || 0,
        tiltY: e.tiltY || 0,
        pointerType: e.pointerType || "unknown",
      };
    }

    function handleStart(e) {
      e.preventDefault();
      isDrawing = true;
      if (!startTime) startTime = Date.now();
      strokeCount++;
      currentStroke = [];

      const point = getEventPos(e);
      currentStroke.push(point);
      drawingData.push({ type: "stroke_start", ...point });

      ctx.beginPath();
      ctx.moveTo(point.x, point.y);
      updateStats();
    }

    function handleMove(e) {
      if (!isDrawing) return;
      e.preventDefault();

      const point = getEventPos(e);
      currentStroke.push(point);
      drawingData.push({ type: "stroke_continue", ...point });

      ctx.lineTo(point.x, point.y);
      ctx.stroke();

      // Log pressure values for testing
      // console.log("Pressure:", point.pressure);

      updateStats();
    }

    function handleEnd(e) {
      if (!isDrawing) return;
      e.preventDefault();
      isDrawing = false;

      if (currentStroke.length > 0) {
        const point = getEventPos(e);
        drawingData.push({ type: "stroke_end", ...point });
      }

      currentStroke = [];
      updateStats();
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawingData = [];
      currentStroke = [];
      strokeCount = 0;
      startTime = null;
      updateStats();
    }

    function saveData() {
      if (drawingData.length === 0) {
        alert("Please draw something before saving!");
        return;
      }

      const jsonData = {
        sessionId: Date.now(),
        totalStrokes: strokeCount,
        dataPoints: drawingData.length,
        duration: startTime ? Date.now() - startTime : 0,
        drawingData,
      };

      const fileName = `handwriting_data_${Date.now()}.json`;
      const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateStats() {
      document.getElementById("pointCount").textContent = drawingData.length;
      document.getElementById("strokeCount").textContent = strokeCount;
      if (startTime) {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById("writingTime").textContent = `${elapsed}s`;
      }
    }

    document.getElementById("clearBtn").addEventListener("click", clearCanvas);
    document.getElementById("saveBtn").addEventListener("click", saveData);

    window.onload = initializeCanvas;
    setInterval(updateStats, 1000);
  </script>
</body>
</html>
